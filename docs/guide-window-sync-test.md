# 窗口同步测试操作手册

## 功能说明

窗口同步功能是指在多个浏览器标签页或窗口中，当用户在一个窗口中进行登录、登出等操作时，其他窗口会自动同步更新登录状态，确保所有窗口的状态保持一致。

## 测试环境要求

1. **浏览器**：支持 localStorage API 的现代浏览器（如 Chrome、Firefox、Edge 等）
2. **前端服务器**：运行在 http://localhost:3000/ 或 http://localhost:3001/（根据实际启动端口）
3. **后端服务器**：运行在 http://localhost:4000/

## 测试步骤

### 测试 1：多标签页登录状态同步

1. **打开第一个标签页**：
   - 在浏览器中打开 http://localhost:3000/（或实际前端服务器地址）
   - 点击左侧菜单的「登录」按钮
   - 输入登录信息（邮箱/用户名和密码）
   - 点击「登录」按钮

2. **打开第二个标签页**：
   - 在同一浏览器中打开新的标签页
   - 访问相同的前端服务器地址（http://localhost:3000/）
   - 观察第二个标签页的左侧菜单，应该自动显示登录后的菜单（如「首页」、「公告管理」、「消息中心」、「个人中心」等）

3. **验证同步效果**：
   - 在第一个标签页中点击「退出登录」
   - 观察第二个标签页的左侧菜单，应该自动切换回未登录状态的菜单（如「登录」、「注册」）

### 测试 2：系统内新开窗口同步

1. **使用测试页面**：
   - 登录系统后，访问 http://localhost:3000/test/window-sync
   - 或者点击左侧菜单中的「窗口同步测试」（如果已配置）

2. **测试普通用户窗口**：
   - 点击「打开普通用户页面」按钮
   - 在新打开的窗口中，应该自动显示登录状态，左侧菜单显示登录后的菜单

3. **测试管理员窗口**：
   - 点击「打开管理员页面」按钮
   - 在新打开的窗口中，应该显示管理员登录页面（如果未登录管理员系统）
   - 登录管理员系统后，观察原窗口和新窗口的状态是否同步

### 测试 3：跨系统登录状态隔离

1. **登录普通用户系统**：
   - 在一个标签页中登录普通用户系统
   - 确认左侧菜单显示普通用户菜单

2. **登录管理员系统**：
   - 在另一个标签页中访问 http://localhost:3000/admin/login
   - 登录管理员系统
   - 确认左侧菜单显示管理员菜单

3. **验证隔离性**：
   - 在普通用户系统标签页中点击「退出登录」
   - 观察管理员系统标签页，应该仍然保持登录状态
   - 在管理员系统标签页中点击「退出登录」
   - 观察普通用户系统标签页，应该仍然保持登出状态

## 预期结果

1. **登录同步**：在一个标签页登录后，其他标签页应该自动更新为登录状态
2. **登出同步**：在一个标签页登出后，其他标签页应该自动更新为登出状态
3. **系统隔离**：普通用户系统和管理员系统的登录状态应该相互独立，一个系统的登出不影响另一个系统的登录状态
4. **新窗口同步**：通过系统内按钮打开的新窗口应该自动继承当前的登录状态

## 技术实现说明

1. **状态存储**：使用 sessionStorage 存储登录状态和令牌信息
2. **同步机制**：使用 localStorage 事件进行跨标签页通信
3. **状态检查**：定期检查登录状态，确保与 sessionStorage 保持同步
4. **系统隔离**：使用不同的令牌存储键（token 和 adminToken）来隔离两个系统的登录状态

## 常见问题及解决方案

### 问题 1：新标签页没有自动同步登录状态

**可能原因**：
- localStorage 事件未触发
- sessionStorage 数据未正确同步

**解决方案**：
- 刷新新标签页
- 检查浏览器控制台是否有错误信息
- 确认前端服务器是否正常运行

### 问题 2：登出后其他标签页没有同步更新

**可能原因**：
- 登出事件未正确触发
- localStorage 事件监听器未正确处理

**解决方案**：
- 刷新其他标签页
- 检查浏览器控制台是否有错误信息
- 确认登出操作是否成功执行

### 问题 3：管理员系统和普通用户系统状态相互影响

**可能原因**：
- 令牌存储键未正确隔离
- 登出逻辑未正确处理系统参数

**解决方案**：
- 检查 userStore.ts 中的登录和登出方法
- 确认是否使用了不同的令牌存储键（token 和 adminToken）
- 测试单独登出一个系统是否影响另一个系统

## 测试验证

完成测试后，请记录以下信息：

1. **测试环境**：浏览器类型及版本、前端服务器端口、后端服务器端口
2. **测试结果**：每个测试步骤的执行情况和结果
3. **问题记录**：遇到的问题及解决方案
4. **建议改进**：对窗口同步功能的改进建议

---

**注意**：窗口同步功能依赖于浏览器的 localStorage API，在某些隐私模式或安全设置下可能会受到限制。如果测试过程中遇到问题，请检查浏览器的隐私设置和安全配置。